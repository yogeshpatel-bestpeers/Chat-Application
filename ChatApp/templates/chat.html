<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FastAPI Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <h4 class="mb-0">Chat App</h4>
            <div><strong>Logged in as:</strong> {{ user }}</div>
        </div>
        <div class="card-body">
            <div class="mb-3 row">
                <label class="col-sm-2 col-form-label">Send To:</label>
                <div class="col-sm-10">
                    <select id="userlist" class="form-select">
                        <option value="" disabled selected>Loading users...</option>
                    </select>
                </div>
            </div>

            <div id="chatBox" class="border p-3 mb-3 rounded bg-white" style="height: 350px; overflow-y: auto;">
                <!-- Messages will appear here -->
            </div>

            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const username = `{{ user }}`;
    const ws = new WebSocket(`ws://localhost:8000/ws/${username}`);
    const chatBox = document.getElementById("chatBox");
    const recipientSelect = document.getElementById("userlist");


    function appendMessage(content, sender, type = "chat") {
        const msgDiv = document.createElement("div");

        if (type === "system") {
            msgDiv.className = "text-center text-muted small mb-2";
            msgDiv.textContent = `[System]: ${content}`;
        } else {
            const isMine = sender === username;
            msgDiv.className = `alert ${isMine ? 'alert-primary text-end' : 'alert-secondary text-start'} p-2 mb-2`;
            msgDiv.innerHTML = `<strong>${isMine ? 'You' : sender}:</strong> ${content}`;
        }

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    ws.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log(data)
            if (data.type === "chat") {
                appendMessage(data.message, data.user);
            } else if (data.type === "system") {
                appendMessage(data.message, null, "system");
            }
        } catch (e) {
            console.error("Invalid message format", e);
        }
    };

    function sendMessage() {
        const input = document.getElementById("messageInput");
        
        const recipient = recipientSelect.value;
        
        const text = input.value.trim();
        console.log(text)
        if (!recipient) {
            alert("Please select a recipient.");
            return;
        }
        if (!text) {
            alert("Cannot send empty message.");
            return;
        }

        ws.send(`${recipient}: ${text}`);
        input.value = '';
    }

    async function loadUsers() {
        try {
            const response = await fetch("http://localhost:8000/users/get");
            if (!response.ok) throw new Error("Failed to fetch users");
            const users = await response.json();

            recipientSelect.innerHTML = "";
            users.forEach(user => {
                if (user.username !== username) {
                    const option = document.createElement("option");
                    option.value = user.username;
                    option.textContent = user.username;
                    recipientSelect.appendChild(option);
                }
            });
        } catch (error) {
            recipientSelect.innerHTML = "";
            const option = document.createElement("option");
            option.textContent = "Error loading users";
            option.disabled = true;
            recipientSelect.appendChild(option);
            console.error(error);
        }
    }

    loadUsers();
</script>
</body>
</html>
